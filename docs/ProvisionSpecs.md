<!-- SPDX-FileCopyrightText: 2024 WithLithum <WithLithum@outlook.com> -->
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->

# Provision Specification

A provision represents an entry in the provisions database that points to a
particular package providing a specified feature (usually a dependency).

## Database

Inside the package scope root, there MUST be a `provisions` directory. Each
entry of the directory MUST be named `<name>.json` where `<name>` is the name
of the provision, and MUST contain the following data in UTF-8:

```json
{
  "name": "<package id>",
  "versions": {
    "<provision version>": {
      "name": "<package name>",
      "version": "<package version>"
    }
  }
}
```

The `name` and `version` property MUST point to a package exists in the local
package scope.

### Generation

The database is generated by iterating over all packages in the local scope and
inspecting the `provides` field of their manifest. 

Each package provides at least one provision, that is one with the same name
and version as the package itself.

The behaviour when two packages provides the same provision is undefined; 
however, per the package scope specification, two packages providing the same
provision MUST be regarded as incompatible.

## Maintenance

### Up-to-date

On each transaction that modifies the database, the program MUST generate a
time-based value, and store it in the package container root, as file `serial`.
And, on each provision database regeneration, the program MUST copy the
`serial` file into the provisions directory.

Whenever the two `serial` file mismatches, the database must be regarded as
having mismatched with the package database and be regenerated.

The time-based value can be any value but MUST be eight-bytes long, and MUST be
time-based or otherwise unique. The file itself doesn't have necessarily be
exactly eight bytes long, however, just the first 8 bytes must be unique.

### Regeneration

If the database in the package scope rootâ€”

- violates this specification; or,
- mismatches with the package database,

then the database files MUST be marked invalid and regenerated from the local
package scope.
