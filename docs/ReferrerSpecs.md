<!-- SPDX-FileCopyrightText: 2024 WithLithum <WithLithum@outlook.com> -->
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->

# Referrer Database Specification

A referrer represents an entry in the referrers database that points to a
particular package that is resolved as a dependency.

## Database

Inside the package scope root, there MUST be a `provisions` directory. Each
entry of the directory MUST be named `<name>.json` where `<name>` is the name
of the provision, and MUST contain the following data in UTF-8:

```json
{
  "<version>": {
    "referrers": {
      "<id>": {
        "name": "<package-name>",
        "version": "<package-version>"
      }
    },
    "current": "<id>"
  }
}
```

The `name` and `version` property MUST point to a package exists in the local
package scope. The current referrer MUST be a valid referrer ID.

The referrer ID can be any string. Programs MUST NOT rely on referrer IDs to
determine which package a referrer refers to; they MUST always parse the entire
referrer for doing this.

### Preferences

Preferences MUST be saved under a file named `ref_preferences.json` in package
scope:

```json
{
  "<package-id>": {
    "<version>": "<referrer-id>"
  }
}
```

When regenerating the provisions database, the referrer specified in the
preferences file MUST be used unless the referrer doesn't exist anymore; in
that case, use the default procedure below.

### Generation

The database is generated by iterating over all packages in the local scope and
inspecting the `provides` field of their manifest. 

Each package provides at least one referrer, that is one with the same name and
version as the package itself.

Whenever two packages provides the same provision, as long as they are not
incompatible with each other (although commonly they do), the preferences
system is used to determine which is used; however, if none is yet specified,
an arbitrary one can be selected to be the current preferred referrer.

## Maintenance

### Up-to-date

On each transaction that modifies the database, the program MUST generate a
time-based value, and store it in the package container root, as file `serial`.
And, on each provision database regeneration, the program MUST copy the
`serial` file into the provisions directory.

Whenever the two `serial` file mismatches, the database must be regarded as
having mismatched with the package database and be regenerated.

The time-based value can be any value but MUST be eight-bytes long, and MUST be
time-based or otherwise unique. The file itself doesn't have necessarily be
exactly eight bytes long, however, just the first 8 bytes must be unique.

### Regeneration

If the database in the package scope rootâ€”

- violates this specification; or,
- mismatches with the package database,

then the database files MUST be and regenerated from the local package scope.
